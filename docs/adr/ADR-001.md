# ADR-001: ERC-8128 v2 Unified Policy Registry + Dual Validation Modules

Status: Draft
Date: 2026-02-12

## Context

Current implementation includes:
- an ERC-1271-focused ERC-8128 module for gateway/API auth
- a separate AA-capable module path with different semantics

As feature scope expanded, we identified risks:
1. policy/state drift across modules if each owns separate storage and conventions
2. duplicated envelope and digest logic causing subtle incompatibilities
3. weak replay-domain binding if signatures are not tightly bound to module + mode
4. scaling issues for batch AA validation when using one-proof-per-leaf
5. operational gaps (emergency controls, explicit install presets, unified eventing)
6. ambiguity around whether v2 changes replace ERC-8128 outer HTTP signature semantics

Backwards compatibility is explicitly not required.

## Decision

Adopt a v2 architecture with:

0. **Explicit ERC-8128 conformance boundary**
- retain ERC-8128 outer HTTP signature processing (RFC-9421 + ERC-191 hash of `M` + keyid semantics + EOA/ERC-1271 verification)
- preserve the ERC-8128 baseline acceptance requirement: Request-Bound + Non-Replayable MUST be accepted
- treat v2 additions as inner delegation/policy extensions, not replacements for ERC-8128 outer signature semantics

1. **Unified onchain policy registry**
- one source of truth for policy state, epoch, policy nonce, scope roots, and emergency controls
- both gateway and AA validation modules read from this registry

2. **Dual-module runtime model with shared core library**
- `GatewayValidationModuleV2`: ERC-1271 path (`validateSignature`)
- `AAValidationModuleV2`: ERC-4337 path (`validateUserOp`)
- shared `ERC8128CoreLib` for key derivation, digesting, signature verification helpers

3. **Canonical `SessionAuthV2` envelope**
- includes `mode`, `requestHash`, `claimsHash`, and common revocation/time fields
- mode-specific claims are ABI-encoded and hash-committed

4. **EIP-712 typed-data signatures for inner delegation (mandatory in v2)**
- bind delegated session authorization signatures to chain, module address, account, entityId, and mode
- do not replace ERC-8128 outer signature construction/verification

5. **AA batch support via Merkle multiproof**
- validate `executeBatch(...)` claims efficiently
- support per-call scope leaves with constraints (`target`, `selector`, `valueLimit`, `allowDelegateCall`)

6. **Operational hardening**
- guardian emergency pause/freeze controls
- install-time secure defaults/presets
- normalized registry event schema for cache/indexing

## Why This Decision

1. **Security correctness**
- shared registry prevents revocation drift across gateway and AA
- typed signatures with module+mode binding reduce replay/ambiguity risk

2. **Maintainability**
- shared library + canonical envelope reduce duplication and long-term divergence

3. **Performance**
- multiproof for batch AA avoids linear proof overhead per call

4. **Operational readiness**
- guardian controls and unified events improve incident response and observability

5. **Pragmatic scope separation**
- dedicated modules preserve clear trust boundaries while still sharing policy truth

## Considered Alternatives

### A1: Keep separate policy storage in each module
Rejected:
- high risk of inconsistent revocation behavior
- duplicate maintenance burden

### A2: Single monolithic module for gateway + AA
Rejected:
- larger attack surface and harder auditing
- more complex selector/routing behavior

### A3: Keep raw digest signing
Rejected:
- weaker standardization and replay-domain clarity than EIP-712
- retained only for ERC-8128 outer signature flow, where ERC-191 over RFC-9421 `M` is required by spec

### A4: Per-leaf proofs only for AA batch
Rejected:
- avoidable calldata/gas overhead for large batches

## Consequences

### Positive

1. Consistent revocation and policy semantics across validation paths.
2. Stronger cryptographic domain separation.
3. Better scalability for AA batch requests.
4. Clearer module responsibilities.

### Negative

1. Larger initial migration effort.
2. New gateway issuance/parsing requirements for v2 envelopes.
3. Additional registry contract to deploy/manage.

### Risk Mitigations

1. Add differential tests between gateway and AA against shared state.
2. Add invariants for revocation and claimsHash binding.
3. Stage rollout with shadow validation in gateway before hard cutover.

## Rollout Plan

1. Implement registry + shared core lib.
2. Implement/deploy v2 gateway and AA modules.
3. Add install presets and selector allowlist defaults.
4. Update gateway to keep ERC-8128 outer verification and add `SessionAuthV2` inner delegation verification (EIP-712).
5. Run shadow mode and compare accept/reject outcomes.
6. Cut over to v2 issuance and disable v1 issuance.

## Follow-Up Work

1. Define exact ABI for `SessionAuthV2`, `GatewayClaimsV2`, and `AAClaimsV2`.
2. Implement multiproof verification path and fuzz harness.
3. Add guardian role management and timelock semantics.
4. Add conformance vectors for gateway parity checks (`created/expires/nonceHash/maxBodyBytes`).
